pipeline {
    agent any
    parameters {
        gitParameter branchFilter: '.*', 
                     defaultValue: 'master', 
                     name: 'BRANCH_NAME', 
                     type: 'PT_BRANCH', 
                     description: 'WÃ¤hle einen Branch aus'
        string(name: 'paramter_for_test', defaultValue: '', description: 'Parameter to test', trim: true)
        choice(name: 'Environment', choices: ['prod'], description: 'Testing Environment')
        booleanParam(name: 'Headles', defaultValue: false, description: 'Run test in headles mode')
        booleanParam(name: 'SEND_EMAIL', defaultValue: false, description: 'Send email notification after tests')
    }
    stages {
        stage('Cleanup') {
            steps {
                script {
                    // Clean previous test results
                    bat 'if exist "test-results" rmdir /s /q "test-results"'
                    bat 'if exist "allure-results" rmdir /s /q "allure-results"'
                    bat 'if exist "playwright-report" rmdir /s /q "playwright-report"'
                    bat 'mkdir test-results'
                }
            }
        }
        stage('Checkout Branch') {
            steps {
                script {
                    // Sicherstellen, dass BRANCH_NAME korrekt initialisiert ist
                    def branchName = params.BRANCH_NAME?.tokenize('/')?.last() ?: 'master'
                    echo "Checking out branch: ${branchName}"

                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/${branchName}"]],
                        userRemoteConfigs: [[url: 'https://github.com/rerdm/PlaywrightTypeScriptFramework.git']]
                    ])
                }
            }
        }
        stage('Install Dependencies') {
            steps {
                script {
                    bat 'npm install'
                    bat 'npx playwright install'
                }
            }
        }
        stage('Run Playwright Tests') {
            steps {
                script {
                    def npmCommand = "npx playwright test ${params.paramter_for_test}"
                    echo "Running command: ${npmCommand}"
                    try {
                        bat "${npmCommand}"
                    } catch (err) {
                        echo "[ERROR] Playwright Tests failed: ${err}"
                        currentBuild.result = 'UNSTABLE'  // Changed from FAILURE to UNSTABLE to continue with reports
                    }
                }
            }
            post {
                always {
                    // Publish JUnit XML test results
                    publishTestResults([
                        testResultsPattern: 'test-results/junit-report.xml'
                    ])
                    
                    // Publish Allure Reports (if Allure plugin is installed)
                    allure([
                        includeProperties: false,
                        jdk: '',
                        properties: [],
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: 'allure-results']]
                    ])
                    
                    // Archive HTML report
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'playwright-report',
                        reportFiles: 'index.html',
                        reportName: 'Playwright HTML Report'
                    ])
                }
            }
        }
        stage('Create and Upload ZIP Artifact') {
            steps {
                script {
                    def timestamp = new Date().format("yyyy-MM-dd_HH-mm")
                    def zipFileName = "playwright-report_${timestamp}.zip"

                    echo "Creating ZIP file: ${zipFileName}"
                    bat "powershell Compress-Archive -Path playwright-report/* -DestinationPath ${zipFileName}"

                    echo "Archiving ZIP file: ${zipFileName}"
                    archiveArtifacts artifacts: zipFileName, allowEmptyArchive: false
                }
            }
        }
        stage('Send Email Notification') {
            when {
                expression { params.SEND_EMAIL == true }
            }
            steps {
                script {

                    def subject = "Jenkins Job: ${env.JOB_NAME} - Branch ${BRANCH_NAME} - Build #${env.BUILD_NUMBER}"
                    def body = """The Jenkins job has completed.

Status: ${currentBuild.currentResult}

Check the Jenkins job details here: ${env.BUILD_URL}

}

"""

                    emailext (
                        to: 'rene.erdmann1987@gmail.com,reneerdmann87@web.de',
                        from: 'Jenkins@no-reply.com',
                        subject: subject,
                        body: body
                    )
                }
            }
        }
    }
}

