pipeline {
    agent any
    parameters {
        gitParameter branchFilter: '.*', 
                     defaultValue: 'master', 
                     name: 'BRANCH_NAME', 
                     type: 'PT_BRANCH', 
                     description: 'WÃ¤hle einen Branch aus'
        string(name: 'paramter_for_test', defaultValue: '', description: 'Parameter to test', trim: true)
        choice(name: 'Environment', choices: ['prod'], description: 'Testing Environment')
        booleanParam(name: 'Headles', defaultValue: false, description: 'Run test in headles mode')
        booleanParam(name: 'SEND_EMAIL', defaultValue: false, description: 'Send email notification after tests')
    }
    stages {
        stage('Checkout Branch') {
            steps {
                script {
                    // Sicherstellen, dass BRANCH_NAME korrekt initialisiert ist
                    def branchName = params.BRANCH_NAME?.tokenize('/')?.last() ?: 'master'
                    echo "Checking out branch: ${branchName}"

                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/${branchName}"]],
                        userRemoteConfigs: [[url: 'https://github.com/rerdm/PlaywrightTypeScriptFramework.git']]
                    ])
                }
            }
        }
        stage('Install Dependencies') {
            steps {
                script {
                    bat 'npm install'
                    bat 'npx playwright install'
                }
            }
        }
        stage('Run Playwright Tests') {
            steps {
                script {
                    def npmCommand = "npx playwright test ${params.paramter_for_test}"
                    echo "Running command: ${npmCommand}"
                    try {
                        bat "${npmCommand}"
                    } catch (err) {
                        echo "[ERROR] Playwright Tests failed: ${err}"
                        currentBuild.result = 'FAILURE'
                    }
                }
            }
        }
        stage('Create and Upload ZIP Artifact') {
            steps {
                script {
                    def timestamp = new Date().format("yyyy-MM-dd_HH-mm")
                    def zipFileName = "playwright-report_${timestamp}.zip"

                    echo "Creating ZIP file: ${zipFileName}"
                    bat "powershell Compress-Archive -Path playwright-report/* -DestinationPath ${zipFileName}"

                    echo "Archiving ZIP file: ${zipFileName}"
                    archiveArtifacts artifacts: zipFileName, allowEmptyArchive: false
                }
            }
        }
        stage('Send Email Notification') {
            when {
                expression { params.SEND_EMAIL == true }
            }
            steps {
                script {
                    echo "Reading test results from results.txt..."

                    def results = readFile('test-results/results.txt').split('\n')
                    results.each { line ->
                        echo line
                    }
                    def formattedResults = uniqueResults.join('\n')
                    def subject = "Jenkins Job: ${env.JOB_NAME} - Branch ${BRANCH_NAME} - Build #${env.BUILD_NUMBER}"
                    def body = """The Jenkins job has completed.

Status: ${currentBuild.currentResult}

Check the Jenkins job details here: ${env.BUILD_URL}

Results:
${formattedResults}

"""

                    emailext (
                        to: 'rene.erdmann1987@gmail.com,reneerdmann87@web.de',
                        from: 'rene.erdmann1987@gmail.com',
                        subject: subject,
                        body: body
                    )
                }
            }
        }
    }
}

